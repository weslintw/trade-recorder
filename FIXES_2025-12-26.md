# 修復記錄 - 2025/12/26

## 問題 1：執行 start.ps1 出現 exit code: -1

### 原因分析
- 腳本中缺少錯誤處理
- 路徑處理不夠健壯，特別是中文路徑
- 沒有檢查服務是否已在運行，導致重複啟動失敗

### 修復內容

#### 1. 添加錯誤處理
```powershell
$ErrorActionPreference = "Stop"
```

#### 2. 使用絕對路徑
```powershell
$ProjectRoot = $PSScriptRoot
Set-Location $ProjectRoot

$minioExe = Join-Path $ProjectRoot "minio.exe"
$backendPath = Join-Path $ProjectRoot "backend"
$frontendPath = Join-Path $ProjectRoot "frontend"
```

#### 3. 檢查服務是否已運行
```powershell
# MinIO
$minioProcess = Get-Process -Name "minio" -ErrorAction SilentlyContinue
if ($minioProcess) {
    Write-Host "[OK] MinIO已經在運行" -ForegroundColor Green
} else {
    # 啟動 MinIO
}

# 後端 (檢查 8080 端口)
$port8080 = Get-NetTCPConnection -LocalPort 8080 -ErrorAction SilentlyContinue
if ($port8080) {
    Write-Host "[OK] 後端已經在運行" -ForegroundColor Green
} else {
    # 啟動後端
}

# 前端 (檢查 5173/5174 端口)
$port5173 = Get-NetTCPConnection -LocalPort 5173 -ErrorAction SilentlyContinue
$port5174 = Get-NetTCPConnection -LocalPort 5174 -ErrorAction SilentlyContinue
if ($port5173 -or $port5174) {
    Write-Host "[OK] 前端已經在運行" -ForegroundColor Green
} else {
    # 啟動前端
}
```

#### 4. 改進用戶交互
```powershell
# 使用 Read-Host 代替 ReadKey（更穩定）
Write-Host "按 Enter 鍵開啟瀏覽器..." -ForegroundColor Yellow
Read-Host
```

---

## 問題 2：外面的卡片可以看到圖，點進去編輯看不到內容

### 原因分析
`RichTextEditor` 組件只在 `onMount` 時設定初始內容，但編輯模式下的資料是異步載入的（在組件掛載之後才從 API 取得），導致編輯器無法顯示已有的內容。

### 修復內容

#### 1. 添加響應式更新（RichTextEditor.svelte）
```javascript
// 響應式更新：當 value 從外部變化時更新編輯器內容
$: if (quill && value !== quill.root.innerHTML) {
  const currentSelection = quill.getSelection();
  quill.root.innerHTML = value || '';
  if (currentSelection) {
    quill.setSelection(currentSelection);
  }
}
```

這個響應式語句會：
- 監聽 `value` 的變化
- 當 `value` 更新時（如從 API 載入資料），自動更新編輯器內容
- 保持當前的游標位置（如果有的話）

#### 2. 確保載入的資料有正確的默認值（TradeForm.svelte）
```javascript
async function loadTrade() {
  try {
    const response = await tradesAPI.getOne(id);
    formData = {
      ...response.data,
      entry_reason: response.data.entry_reason || '',
      exit_reason: response.data.exit_reason || '',
      notes: response.data.notes || '',
      entry_time: new Date(response.data.entry_time).toISOString().slice(0, 16),
      exit_time: response.data.exit_time ? new Date(response.data.exit_time).toISOString().slice(0, 16) : '',
      tags: response.data.tags?.map(t => t.name) || [],
    };
  } catch (error) {
    console.error('載入交易失敗:', error);
    alert('載入交易資料失敗');
  }
}
```

確保 `entry_reason`、`exit_reason`、`notes` 即使是 `null` 也會轉換為空字串 `''`，避免傳遞 `null` 給編輯器。

---

## 測試步驟

### 測試問題 1 的修復
1. 關閉所有正在運行的服務
2. 執行 `.\start.ps1`
3. 應該看到：
   - ✅ 沒有 exit code -1 錯誤
   - ✅ 三個服務正常啟動
   - ✅ 瀏覽器自動打開

4. 再次執行 `.\start.ps1`（不關閉服務）
5. 應該看到：
   - ✅ 檢測到服務已在運行
   - ✅ 不會重複啟動
   - ✅ 正常完成

### 測試問題 2 的修復
1. 開啟應用 `http://localhost:5173`
2. 新增一筆交易，在「進場理由」中貼上圖片和文字
3. 儲存交易
4. 在列表中應該能看到：
   - ✅ 卡片顯示「進場理由」的內容（包含圖片）
5. 點擊卡片進入編輯模式
6. 應該能看到：
   - ✅ 「進場理由」編輯器顯示完整內容（文字+圖片）
   - ✅ 「平倉理由」編輯器顯示內容（如果有）
   - ✅ 「交易筆記」編輯器顯示內容（如果有）

---

## 技術細節

### Svelte 響應式語句
```javascript
$: expression
```
- 這是 Svelte 的響應式語法
- 當 `expression` 中引用的任何變量改變時，語句會自動重新執行
- 非常適合用於同步外部狀態到組件內部

### Quill 編輯器內容更新
```javascript
quill.root.innerHTML = value;
```
- 直接設定編輯器的 HTML 內容
- 比使用 `quill.setContents()` 更簡單直接
- 適合從外部更新整個內容

---

## 服務狀態檢查

| 服務 | 端口 | 檢查方法 |
|------|------|----------|
| MinIO | 9000/9001 | `Get-Process -Name "minio"` |
| 後端 | 8080 | `Get-NetTCPConnection -LocalPort 8080` |
| 前端 | 5173/5174 | `Get-NetTCPConnection -LocalPort 5173` |

---

## 已修復的文件

1. ✅ `start.ps1` - 改進啟動腳本
2. ✅ `frontend/src/components/RichTextEditor.svelte` - 添加響應式更新
3. ✅ `frontend/src/components/TradeForm.svelte` - 確保資料默認值

---

**測試完成後請重新整理瀏覽器頁面，確保載入最新的程式碼！** 🎉

